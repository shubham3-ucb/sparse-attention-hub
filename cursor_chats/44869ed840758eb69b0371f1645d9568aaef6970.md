# Validate sampling masker configuration
_Exported on 7/8/2025 at 01:01:15 PDT from Cursor (1.2.2)_

---

**User**

In creation of researchattention , we have to validate the config -- right now we only support Masker list that contains at most one sampling masker. Please validate this while creating the ResearchAttention class object and raise error with message "Only one sampling masker supported for efficiency; consider implementing all sampling logic in one masker"

---

**Cursor**

I'll help you add validation to ensure that the ResearchAttention class only accepts at most one sampling masker. Let me first explore the codebase to understand the structure of the ResearchAttention class and the masker system.

Now let me search for sampling maskers to understand what constitutes a "sampling masker":

Now I'll check the exact structure of the ResearchAttention class and add the validation. Let me examine the current ResearchAttention implementation:

Now I'll add the validation to the ResearchAttention class. I need to import the SamplingMasker class and add the validation logic:

```python
from ..base import SparseAttention, SparseAttentionConfig
from ..utils.mask import Mask
from ..utils.mask_attention_utils import get_masked_attention_output
from .maskers.base import MaskerConfig, ResearchMasker

->

from ..base import SparseAttention, SparseAttentionConfig
from ..utils.mask import Mask
from ..utils.mask_attention_utils import get_masked_attention_output
from .maskers.base import MaskerConfig, ResearchMasker
from .maskers.sampling.base import SamplingMasker
```

```python
    def __init__(
        self,
        sparse_attention_config: SparseAttentionConfig,
        maskers: List[ResearchMasker],
    ) -> None:
        """Initialize research attention mechanism.

        Args:
            sparse_attention_config: Configuration for the sparse attention mechanism.
            maskers: List of research maskers to apply.
        """
        super().__init__(sparse_attention_config)
        self.maskers = maskers

->

    def __init__(
        self,
        sparse_attention_config: SparseAttentionConfig,
        maskers: List[ResearchMasker],
    ) -> None:
        """Initialize research attention mechanism.

        Args:
            sparse_attention_config: Configuration for the sparse attention mechanism.
            maskers: List of research maskers to apply.
        
        Raises:
            ValueError: If more than one sampling masker is provided.
        """
        super().__init__(sparse_attention_config)
        
        # Validate that there's at most one sampling masker
        sampling_masker_count = sum(1 for masker in maskers if isinstance(masker, SamplingMasker))
        if sampling_masker_count > 1:
            raise ValueError("Only one sampling masker supported for efficiency; consider implementing all sampling logic in one masker")
        
        self.maskers = maskers
```

Now let me create a simple test to verify that the validation works correctly. Let me check if there are existing tests and add a test for this validation:

```python
@pytest.mark.unit
class TestInheritance:
    """Test class for inheritance."""

    def test_inheritance(self):
        """Test that research attention inherits from sparse attention."""
        from sparse_attention_hub.sparse_attention import (
            SparseAttention,
            SparseAttentionConfig,
        )
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
            ResearchAttentionConfig,
        )

        assert issubclass(ResearchAttention, SparseAttention)
        assert issubclass(ResearchAttentionConfig, SparseAttentionConfig)

->

@pytest.mark.unit
class TestInheritance:
    """Test class for inheritance."""

    def test_inheritance(self):
        """Test that research attention inherits from sparse attention."""
        from sparse_attention_hub.sparse_attention import (
            SparseAttention,
            SparseAttentionConfig,
        )
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
            ResearchAttentionConfig,
        )

        assert issubclass(ResearchAttention, SparseAttention)
        assert issubclass(ResearchAttentionConfig, SparseAttentionConfig)


@pytest.mark.unit
class TestSamplingMaskerValidation:
    """Test class for sampling masker validation."""

    def test_single_sampling_masker_allowed(self):
        """Test that a single sampling masker is allowed."""
        from sparse_attention_hub.sparse_attention import SparseAttentionConfig
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
            ResearchAttentionConfig,
        )
        from sparse_attention_hub.sparse_attention.research_attention.maskers.fixed import (
            LocalMasker,
            LocalMaskerConfig,
        )
        from sparse_attention_hub.sparse_attention.research_attention.maskers.sampling import (
            RandomSamplingMasker,
            RandomSamplingMaskerConfig,
        )

        # Create maskers: one fixed, one sampling
        local_masker = LocalMasker.create_from_config(LocalMaskerConfig(window_size=10))
        sampling_masker = RandomSamplingMasker.create_from_config(
            RandomSamplingMaskerConfig(sampling_rate=0.5)
        )

        # This should not raise an error
        config = SparseAttentionConfig()
        attention = ResearchAttention(config, [local_masker, sampling_masker])
        assert attention is not None
        assert len(attention.maskers) == 2

    def test_multiple_sampling_maskers_rejected(self):
        """Test that multiple sampling maskers are rejected."""
        from sparse_attention_hub.sparse_attention import SparseAttentionConfig
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
        )
        from sparse_attention_hub.sparse_attention.research_attention.maskers.sampling import (
            RandomSamplingMasker,
            RandomSamplingMaskerConfig,
            MagicPig,
            MagicPigConfig,
        )

        # Create two sampling maskers
        random_masker = RandomSamplingMasker.create_from_config(
            RandomSamplingMaskerConfig(sampling_rate=0.5)
        )
        magic_pig_masker = MagicPig.create_from_config(
            MagicPigConfig(sampling_rate=0.3, lsh_l=4, lsh_k=16)
        )

        # This should raise an error
        config = SparseAttentionConfig()
        with pytest.raises(ValueError, match="Only one sampling masker supported for efficiency; consider implementing all sampling logic in one masker"):
            ResearchAttention(config, [random_masker, magic_pig_masker])

    def test_multiple_sampling_maskers_via_config(self):
        """Test that multiple sampling maskers are rejected when created via config."""
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
            ResearchAttentionConfig,
        )
        from sparse_attention_hub.sparse_attention.research_attention.maskers.sampling import (
            RandomSamplingMaskerConfig,
            MagicPigConfig,
        )

        # Create config with two sampling maskers
        masker_configs = [
            RandomSamplingMaskerConfig(sampling_rate=0.5),
            MagicPigConfig(sampling_rate=0.3, lsh_l=4, lsh_k=16),
        ]
        config = ResearchAttentionConfig(masker_configs=masker_configs)

        # This should raise an error
        with pytest.raises(ValueError, match="Only one sampling masker supported for efficiency; consider implementing all sampling logic in one masker"):
            ResearchAttention.create_from_config(config)

    def test_no_sampling_maskers_allowed(self):
        """Test that no sampling maskers is allowed."""
        from sparse_attention_hub.sparse_attention import SparseAttentionConfig
        from sparse_attention_hub.sparse_attention.research_attention import (
            ResearchAttention,
        )
        from sparse_attention_hub.sparse_attention.research_attention.maskers.fixed import (
            LocalMasker,
            LocalMaskerConfig,
            SinkMasker,
            SinkMaskerConfig,
        )

        # Create only fixed maskers
        local_masker = LocalMasker.create_from_config(LocalMaskerConfig(window_size=10))
        sink_masker = SinkMasker.create_from_config(SinkMaskerConfig(sink_size=5))

        # This should not raise an error
        config = SparseAttentionConfig()
        attention = ResearchAttention(config, [local_masker, sink_masker])
        assert attention is not None
        assert len(attention.maskers) == 2
```

Now let me run the tests to make sure the validation works correctly:

---

**User**

[SUCCESS] all good

---

**Cursor**

Perfect! I've successfully implemented the validation for the ResearchAttention class. Here's a summary of what was accomplished:

## Changes Made

1. **Added validation logic to ResearchAttention.__init__()** in `sparse_attention_hub/sparse_attention/research_attention/base.py`:
   - Imported `SamplingMasker` class to identify sampling maskers
   - Added validation that counts sampling maskers in the provided list
   - Raises `ValueError` with the exact message you requested: "Only one sampling masker supported for efficiency; consider implementing all sampling logic in one masker"

2. **Added comprehensive tests** in `tests/unit/sparse_attention/research_attention/test_base.py`:
   - Test that single sampling masker is allowed
   - Test that multiple sampling maskers are rejected (direct instantiation)
   - Test that multiple sampling maskers are rejected (via config)
   - Test that no sampling maskers is allowed

## Key Features

- **Validation occurs during object creation**: Both direct instantiation and `create_from_config()` will trigger the validation
- **Exact error message**: Uses the message you specified
- **Comprehensive coverage**: Works with any masker that inherits from `SamplingMasker` (like `RandomSamplingMasker`, `MagicPig`, etc.)
- **Well-tested**: Multiple test cases ensure the validation works correctly in different scenarios

The validation ensures that users can only have at most one sampling masker in their ResearchAttention configuration, promoting efficiency by encouraging consolidated sampling logic.

